---
title: "MacroSheds Solute Trends"
author: "Nick Gubbins"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      include = TRUE,
                      tidy.opts = list(width.cutoff = 60), 
                      tidy = TRUE,
                      warning = F,
                      message = F)
# needed packages
library(here)
library(tidyverse)
library(lubridate)
library(mapview)
library(sf)
library(tigris)
library(RColorBrewer)
library(leaflet)
library(sp)
library(ggthemes)
library(macrosheds)

# source model fitting function
source('analyze_trend.R')

# set color ramps
colors = colorRampPalette(c('blue', 'dark red'))

```

# Scope
Provide a high level analysis of trends in riverine solute concentrations throughout the MS database. 

# Calculate Trends
After running load_data, you can run the following functions to generate the trends data set. The function will apply to all the sites you have downloaded in your MS data directory.

```{r}
#analyze_trend(target_solute = 'SO4_S', ms_root = here('ms_data'))
#analyze_trend(target_solute = 'pH', ms_root = here('ms_data'))
#analyze_trend(target_solute = 'DOC', ms_root = here('ms_data'))
```

The 'analyze_trend' function calculates annual and seasonal trends for sites that meet the required data cutoffs. The current cutoffs are

- Site is in the CONUS

- Data across at least 10 water years

- Data across at least 3 seasons

- There are at least 3 samples in 10 or more seasons

The function then applies 5 linear models (annual + four seasons) across mean, low (5% percentile value), and high concentrations for each time period. The function uses USGS water years for annual aggregation and simple, three month periods for each season.

# Summarizing trends

```{r}
trends <- read_csv(here('trends','SO4_S_trends.csv'), show_col_types = FALSE) %>%
    rbind(.,read_csv(here('trends','DOC_trends.csv'), show_col_types = FALSE)) %>%
    rbind(.,read_csv(here('trends','pH_trends.csv'), show_col_types = FALSE)) 

site_data <- ms_load_sites()

sf_trends <- trends %>%
    left_join(., site_data, by = c('site' = 'site_code', 'domain')) %>%
    filter(!is.na(longitude),
           !is.na(latitude)) %>%
    st_as_sf(., coords = c('longitude', 'latitude'), crs = 4326)

sf_trends %>%
    select(domain_fullname, site, n_ann, geometry) %>%
    distinct() %>%
    mapview(.,
            zcol = 'n_ann',
            legend = T,
            label = 'domain_fullname',
            layer.name = 'Years of data')
```


The map above shows good national coverage. Sites are colored by years of data available. 

# Trends in DOC

First, let's take a look at how annual DOC has been trending in the MS database:

```{r}
so4_ann <- sf_trends %>%
    filter(solute == 'SO4_S') %>%
    select(domain_fullname, site, n_ann, 
           slope_ann_mean, p_ann_mean, rsquared_ann_mean, geometry)

ggplot(so4_ann)+
    geom_histogram(aes(x = slope_ann_mean)) +
    labs(x = 'Slope of trendline',
         caption = paste('n=',nrow(so4_ann))) +
    theme_few()

mapview(so4_ann,
        zcol = 'slope_ann_mean',
        legend = T,
        label = 'domain_fullname',
        layer.name = 'Trend',
        col.regions= colors)
```

The same map with only significant (p value < 0.05) trends:
```{r}
so4_ann_sig <- so4_ann %>%
    filter(p_ann_mean < 0.05)

print(paste('Ratio of signifcant to total trends is ', signif(nrow(so4_ann_sig)/nrow(so4_ann), digits = 2)))

ggplot(so4_ann_sig)+
    geom_histogram(aes(x = slope_ann_mean)) +
    labs(x = 'Slope of trendline',
         caption = paste('n=',nrow(so4_ann_sig))) +
    theme_few()

mapview(so4_ann_sig,
        zcol = 'slope_ann_mean',
        legend = T,
        label = 'domain_fullname',
        layer.name = 'Trend',
        col.regions= colors)
```



